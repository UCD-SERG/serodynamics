---
title: "Serodynamics Analysis for Multiple Subjects"
author: "Kwan Ho Lee"
date: "`r Sys.Date()`"
format: html
jupyter: false
---

# Introduction

This document demonstrates the full workflow using the **serodynamics** package. In this analysis, we run JAGS models for three different subjects:

-   **sees_npl_128 (HlyE_IgA)**
-   **sees_npl_131 (HlyE_IgA)**
-   **sees_npl_133 (HlyE_IgG)**

For each subject, we process the JAGS output to extract median parameter estimates and generate predicted antibody response curve plots.

```{r,echo=FALSE, message=FALSE, warning=FALSE}
devtools::document()
library(serodynamics)
library(dplyr)
library(fs)
library(DT)
```

# Run Models for Each Subject

```{r,echo=FALSE, message=FALSE, warning=FALSE}
dataset <- nepal_sees |>
  as_case_data(id_var = "person_id",
               biomarker_var = "antigen_iso",
               value_var = "value",
               time_in_days = "timeindays")

# Extract specific subject and antigen data 
  dat <- filter(dataset, 
                id == "sees_npl_128", 
                antigen_iso == "HlyE_IgA")

# Optionally filter the dataset for visit 5
filtered_dataset <- dataset %>% 
  filter(visit_num == 5)%>%
  select(Country,id,antigen_iso,visit_num)

DT::datatable(filtered_dataset, options = list(pageLength = 5, scrollX = TRUE))

```

## Subject: sees_npl_128 (HlyE_IgA)

```{r,echo=FALSE, message=FALSE, warning=FALSE,results='hide'}
# Run JAGS model for subject sees_npl_128
dataset <- nepal_sees |>
  as_case_data(id_var = "person_id",
               biomarker_var = "antigen_iso",
               value_var = "value",
               time_in_days = "timeindays")|>
  rename(
    strat = bldculres,
    timeindays = dayssincefeveronset,
    value = result
  )


# Run JAGS model for the entire dataset
model <- run_mod(
  data = dataset,
  file_mod = serodynamics_example("model.jags"),  
  nchain = 2,
  nadapt = 100,
  nburn = 100,
  nmc = 500,
  niter = 1000,
  strat = "strat",
  include_subs = TRUE
)


full_samples <- process_jags_samples(model, 
                                     dataset,
                                     id = "sees_npl_128",
                                     antigen_iso = "HlyE_IgA")

```

## Display Specific MCMC Sample Parameters (1000 samples of sees_npl_128 (HlyE_IgA))

```{r,echo=FALSE, message=FALSE}
DT::datatable(full_samples, options = list(pageLength = 10, scrollX = TRUE))

```
\newpage

# Plotting Predicted Antibody Response Curves

Below are three versions of the predicted antibody response curves:

-   [**plot**]{.underline}: A plot using full MCMC samples (without log scale).

-   [**plot2**]{.underline}: A plot using full MCMC samples with a log10 scale on the y-axis.


\newpage

## Generate Plots

Below are three versions of the plot:

```{r,echo=FALSE, message=FALSE, warning=FALSE,results='hide'}

# Plot using full MCMC samples (linear x-axis) with individual curves.
plot <- plot_predicted_curve(
  param_medians_wide = full_samples,
  dat = dat,
  legend_obs = "Observed Data",
  legend_mod1 = "Full Model Predictions",
  show_quantiles = TRUE,
  log_scale = FALSE,
  log_x = FALSE,
  show_all_curves = TRUE
)

# Plot using full MCMC samples (log10 x- and y-axis) with individual curves.
plot2 <- plot_predicted_curve(
  param_medians_wide = full_samples,
  dat = dat,
  legend_obs = "Observed Data",
  legend_mod1 = "Full Model Predictions",
  show_quantiles = TRUE,
  log_scale = TRUE,
  log_x = FALSE,
  show_all_curves = TRUE
)

```

### Plot

```{r,echo=FALSE, message=FALSE}
plot
```

Displays the median curve along with the 95% credible interval (ribbon) derived from the full MCMC samples on a linear scale.

\newpage

### Plot2

```{r,echo=FALSE, message=FALSE}
plot2
```

The same as Plot but with a log10-transformed y-axis, which can help visualize differences when antibody levels span several orders of magnitude.

## Interpretation

In Plot2, the 95% credible band appears broad, particularly at later times, suggesting substantial uncertainty in long-term antibody decay—likely driven by parameters such as the decay rate (α) and the shape parameter. This broad interval indicates that, given the data, a wide range of decay trajectories is plausible. However, a narrow credible band does not necessarily imply a good fit to the data. To properly assess model fit, we could use Bayesian goodness-of-fit metrics such as posterior predictive checks (which packages like ggs may already provide) to compare the observed data with data simulated from the model's posterior.