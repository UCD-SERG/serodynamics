---
title: "R Notebook"
output: html_notebook
---

## load packages and data
```{r}

library(tidyverse)
#library(serocalculator)
load_all()

# install.packages("pak")
#pak::pak("UCD-SERG/serodynamics")



#load SEES data and prepare 
d0 <- 
  read.csv("~/Documents/GitHub/serodynamics/inst/extdata/elisa_clean_2024-06-05.csv") %>%
  filter(surgical != 1 | is.na(surgical)) %>%
  filter(Arm == "Prospective Cases" | Arm == "Retrospective Cases") %>%
  mutate(Hospitalized = ifelse((recloc == "Inpatient Department" | admithosp_seap == "Yes"), "Yes", "No")) %>% 
  mutate(antigen_iso = paste(elisa_antigen, "_", elisa_antbdy_iso, sep="")) %>%
  mutate(TimeInDays = ifelse(is.na(dayssincefeveronset), timesince0, dayssincefeveronset)) %>%
  mutate(TimePeriod = factor(TimePeriod, levels = c("Baseline","First visit", "28 days", "3 months","6 months", "12 months", "18 months", "24 months"))) %>%
  mutate(visit = as.numeric(TimePeriod)) %>%
  group_by(index_id, TimePeriod) %>% mutate(nVisits=n()) %>%
  ungroup() %>%
  filter(antigen =="HlyE") %>%
  #filter(antigen_iso == "HlyE_IgG") %>%
  select(index_id, Country, seapage, bldculres, Hospitalized, antigen_iso, result, TimePeriod,  postreinf, samplenum,  TimeInDays, reinf_obs) %>%
  mutate(postreinf= ifelse(is.na(postreinf), 0, postreinf)) %>%
  rename(age = seapage) %>%
  rename(visit = samplenum)  %>%
  janitor::clean_names() %>%
    #remove reinfection events
  filter(postreinf != 1) %>%
  filter(country=="Bangladesh") %>%
    mutate(agecat = case_when(age < 5 ~ "0-4",
                              age >= 5 & age < 15 ~ "5-14",
                              age >= 15 ~ "16+")) %>%
  filter(agecat != "16+") %>%
  droplevels()
      # mutate(agecat = case_when(age < 5 ~ "<5",
      #                         age >= 5  ~ ">5"))

  





#all <- d0 %>% mutate(reinfec_pop = "all data")
#reinf_rem <- d0 %>% filter(postreinf != 1) %>% mutate(reinfec_pop = "reinf removed")


```



## make longitudinal data "case_data"object
```{r}

  

dl_case <- as_case_data(d0 %>% filter(!is.na(age)),
                   id_var = "index_id",
                   biomarker_var = "antigen_iso",
                   value_var = "result",
                   time_in_days = "time_in_days")


```

## Run model
```{r}


# y1_prior <- log(quantile(get_values(dl_case), 0.99))
# y0_prior <-log(quantile(get_values(dl_case), .05))
# t1_prior <- 2
# alpha_prior <- -2
# shape_prior <- -3
# prec.prior <- c(0.1, 0.1, 0.1, 0.1, 0.1)
# omega.prior <- c(0.1, 0.1, 0.1, 0.1, 0.1)

#lancet microbe priors 
y1_prior <- 7.0
y0_prior <- 1.0
t1_prior <- 1.0
alpha_prior <- -4.0
shape_prior <- -1.0
prec.prior <- c(1.0,   0.00001,   1.0,   0.001,  1.0)
omega.prior <- c(1.0,  50.0,   1.0,   10.0,  1.0)


mod2 <- run_mod(data = dl_case,
                file_mod = fs::path_package("serodynamics", "extdata/model.jags"),
                nchain = 4,
                nadapt = 2000,
                #nadapt = 1000,
                nburn = 1000,
                nmc = 2500,
                #nmc = 1000,
                niter = 4000, 
                #niter = 1000, 
                mu_hyp_param = c( y0_prior,  y1_prior,  t1_prior, alpha_prior, shape_prior),
                prec_hyp_param = prec.prior,
                omega_param = omega.prior, 
               strat = "agecat")



mod_np <- mod2 %>% filter(Subject == "newperson")

```




## Diagnostics
```{r}


plot_jags_trace(mod_np)

plot_jags_Rhat(mod_np)



```



## Serocourse

```{r}


wide_predpar_df <- mod_np  %>%
      pivot_wider(names_from = "Parameter", values_from="value") %>%
      rowwise() %>%
      #mutate(y1 = y0+y1) %>%
      droplevels() %>%
      ungroup() 




#wide_predpar_df <- readRDS("~/Documents/GitHub/serodynamics/inst/extdata/serocalculator_curve_params_byAgecat_reinfec.rds")


# Generate a sequence of time points
tx2 <- 10^seq(-1, 3, 0.025)
#tx2 <- seq(0, 1500, by = 1)



serocourse <- wide_predpar_df %>%
  rowwise() %>%  # Treat each row independently.
  mutate(decay_curve = list(
    tibble(
      t = tx2,
      y = serocalculator:::ab0(tx2, curve_params = cur_data())
    )
  )) %>%
  ungroup() %>%
  unnest(decay_curve) %>%
  mutate(id = paste0(Stratification, Subject, Iteration, "-", Chain))



serocourse_sum <- serocourse %>%
  summarise(
    res.med  = quantile(y, 0.5),
    res.low  = quantile(y, 0.025),
    res.high = quantile(y, 0.975), .by = c("Iso_type", "t", "Stratification")
  ) 
 



  
ggplot(
  serocourse_sum %>% filter(Iso_type %in% c("HlyE_IgG", "HlyE_IgA")) %>% filter(t <580),
  aes(x = t, color = Stratification, fill = Stratification)
) +
  geom_ribbon(
    aes(ymin = res.low, ymax = res.high),
    alpha = 0.2,     # Light shading
    color = NA       # No border on the ribbon itself
  ) +
  geom_line(
    aes(y = res.med)
  ) +
  facet_wrap(~Iso_type) +
  scale_y_log10(limits = c(0.1,1000), labels = scales::label_number(accuracy = 0.1)) +
  #scale_x_log10() +
  theme_linedraw() +
  labs(
    x = "Days since admission",
    y = "Antibody Concentration"
  )


```



## save
```{r}
# write_rds(wide_predpar_df, "~/Documents/GitHub/serodynamics/inst/extdata/sees_mcmc_unstratified_ReinfectionsIncluded.rds")


```