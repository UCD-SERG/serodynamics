---
title: "Getting Started with serodynamics"
format: html
---

```{r}
#| include: false
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

## Introduction

The `{serodynamics}` package provides tools for modeling longitudinal antibody responses to infection using Bayesian MCMC methods. This vignette demonstrates the main workflow for:

1. Loading or simulating case data
2. Preparing data for MCMC analysis
3. Running the Bayesian model
4. Visualizing and interpreting results

## Installation

First, ensure you have JAGS installed on your system (required for Bayesian MCMC):

- **Ubuntu/Linux**: `sudo apt-get install jags`
- **macOS**: Download from [JAGS website](https://sourceforge.net/projects/mcmc-jags/)
- **Windows**: Download from [JAGS website](https://sourceforge.net/projects/mcmc-jags/)

Then install the package:

```r
# install.packages("pak")
pak::pak("UCD-SERG/serodynamics")
```

## Load Required Libraries

```{r}
#| label: setup
#| message: false
#| warning: false
library(serodynamics)
library(runjags)
library(dplyr)
library(ggplot2)

# Verify JAGS is installed
runjags::findJAGS()
```

## Example 1: Using Existing Data

The package includes example data from the SEES Typhoid study in Nepal:

```{r}
#| label: load-data
data(nepal_sees)
head(nepal_sees)
```

### Prepare the Data

Convert the data to a `case_data` object
(`nepal_sees` already is a `case_data` object, 
but we can reconvert it just to demonstrate).

```{r}
#| label: prepare-data
case_data <- as_case_data(
  nepal_sees,
  id_var = "id",
  time_in_days = "dayssincefeveronset",
  value_var = "result",
  biomarker_var = "antigen_iso"
)

# View the structure
head(case_data)
```

### Visualize the Raw Data

```{r}
#| label: plot-raw-data
#| fig-width: 8
#| fig-height: 6
autoplot(case_data)
```

## Example 2: Simulating Data

You can also simulate case data using antibody curve parameters:

```{r}
#| label: simulate-data
set.seed(123)

# Use typhoid curve parameters from serocalculator
simulated_data <- sim_case_data(
  n = 50,  # Number of cases to simulate
  curve_params = serocalculator::typhoid_curves_nostrat_100,
  max_n_obs = 6,  # Maximum observations per case
  followup_interval = 14  # Days between follow-up visits
)

head(simulated_data)
```

```{r}
#| label: plot-simulated
#| fig-width: 8
#| fig-height: 6
autoplot(simulated_data)
```

## Running the Bayesian Model

### Prior Predictive Checks (Recommended)

**Before fitting the model**, it's recommended to perform a prior predictive check to ensure your priors generate realistic antibody trajectories:

```{r}
#| label: prior-predictive-check
# Prepare data and priors
prepped_data <- prep_data(simulated_data)
prepped_priors <- prep_priors(max_antigens = prepped_data$n_antigen_isos)

# Simulate from priors
sim_prior <- simulate_prior_predictive(
  prepped_data, 
  prepped_priors, 
  n_sims = 30,
  seed = 456
)

# Summarize and check for issues
summarize_prior_predictive(sim_prior, original_data = prepped_data)

# Visualize prior predictive trajectories
plot_prior_predictive(sim_prior, original_data = prepped_data)
```

If the prior predictive check shows issues (e.g., unrealistic scales, non-finite values), adjust the priors using `prep_priors()` with custom parameters before proceeding. See `vignette("prior-predictive-checks")` for detailed guidance.

### Fitting the Model

The main function `run_mod()` fits a Bayesian MCMC model to estimate antibody dynamic curve parameters:

- `y0`: Baseline antibody concentration
- `y1`: Peak antibody concentration  
- `t1`: Time to peak
- `shape`: Shape parameter
- `alpha`: Decay rate

```{r}
#| label: run-model
# Note: This example uses reduced iterations for demonstration
# For actual analysis, use larger values (e.g., nmc=1000, niter=2000)

fitted_model <- run_mod(
  data = simulated_data,
  file_mod = serodynamics_example("model.jags"),
  nchain = 2,      # Number of MCMC chains
  nadapt = 100,    # Adaptation iterations
  nburn = 100,     # Burn-in iterations  
  nmc = 10,        # Samples per chain (use 1000+ for real analysis)
  niter = 20       # Total iterations (use 2000+ for real analysis)
)

head(fitted_model)
```

## Model Diagnostics

After fitting the model, check convergence diagnostics:

```{r}
#| label: diagnostics
# Trace plots to assess chain mixing
plot_jags_trace(fitted_model)

# Density plots of posterior distributions
plot_jags_dens(fitted_model)

# Rhat statistics (values near 1.0 indicate convergence)
plot_jags_Rhat(fitted_model)

# Effective sample size
plot_jags_effect(fitted_model)
```

## Visualizing Fitted Curves

Plot the predicted antibody curves with credible intervals:

```{r}
#| label: plot-curves
plot_predicted_curve(
  fitted_model,
  ids = serocalculator::ids(simulated_data)[1],
  antigen_iso = simulated_data$antigen_iso[1]
)
```

## Post-Processing Results

Extract and summarize the posterior estimates:

```{r}
#| label: postprocess
# Summarize parameter estimates
summary_stats <- post_summ(fitted_model)
print(summary_stats)
```

## Working with Stratified Data

You can stratify the analysis by a grouping variable:

```{r}
#| label: stratified-example
# Create stratified data
strat1 <- sim_case_data(
  n = 30, 
  curve_params = serocalculator::typhoid_curves_nostrat_100
) |>
  mutate(pathogen = "Typhoid")

strat2 <- sim_case_data(
  n = 30,
  curve_params = serocalculator::typhoid_curves_nostrat_100  
) |>
  mutate(pathogen = "Paratyphoid")

stratified_data <- bind_rows(strat1, strat2)

# Fit model with stratification
fitted_stratified <- run_mod(
  data = stratified_data,
  file_mod = serodynamics_example("model.jags"),
  nchain = 2,
  nadapt = 100,
  nburn = 100,
  nmc = 10,
  niter = 20,
  strat = "pathogen"  # Specify stratification variable
)
```

## Next Steps

- See the [function reference](../reference/index.html) for complete API documentation
- Check out example datasets: `?nepal_sees`, `?nepal_sees_jags_output`

## Session Info

```{r}
#| label: session-info
sessioninfo::session_info()
```
