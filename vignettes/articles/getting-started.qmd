---
title: "Getting Started with serodynamics"
format: html
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

## Introduction

The `{serodynamics}` package provides tools for modeling longitudinal antibody responses to infection using Bayesian MCMC methods. This vignette demonstrates the main workflow for:

1. Loading or simulating case data
2. Preparing data for MCMC analysis
3. Running the Bayesian model
4. Visualizing and interpreting results

## Installation

First, ensure you have JAGS installed on your system (required for Bayesian MCMC):

- **Ubuntu/Linux**: `sudo apt-get install jags`
- **macOS**: Download from [JAGS website](https://sourceforge.net/projects/mcmc-jags/)
- **Windows**: Download from [JAGS website](https://sourceforge.net/projects/mcmc-jags/)

Then install the package:

```r
# install.packages("pak")
pak::pak("UCD-SERG/serodynamics")
```

## Load Required Libraries

```{r setup, message=FALSE, warning=FALSE}
library(serodynamics)
library(runjags)
library(dplyr)
library(ggplot2)

# Verify JAGS is installed
runjags::findJAGS()
```

## Example 1: Using Existing Data

The package includes example data from the SEES Typhoid study in Nepal:

```{r load-data}
data(nepal_sees)
head(nepal_sees)
```

### Prepare the Data

Convert the data to a `case_data` object:

```{r prepare-data}
case_data <- as_case_data(
  nepal_sees,
  id_var = "person_id",
  time_var = "dayssincefeveronset",
  value_var = "result",
  biomarker_var = "antigen_iso"
)

# View the structure
head(case_data)
```

### Visualize the Raw Data

```{r plot-raw-data, fig.width=8, fig.height=6}
autoplot(case_data)
```

## Example 2: Simulating Data

You can also simulate case data using antibody curve parameters:

```{r simulate-data}
set.seed(123)

# Use typhoid curve parameters from serocalculator
simulated_data <- sim_case_data(
  n = 50,  # Number of cases to simulate
  curve_params = serocalculator::typhoid_curves_nostrat_100,
  max_n_obs = 6,  # Maximum observations per case
  followup_interval = 14  # Days between follow-up visits
)

head(simulated_data)
```

```{r plot-simulated, fig.width=8, fig.height=6}
autoplot(simulated_data)
```

## Running the Bayesian Model

The main function `run_mod()` fits a Bayesian MCMC model to estimate antibody dynamic curve parameters:

- `y0`: Baseline antibody concentration
- `y1`: Peak antibody concentration  
- `t1`: Time to peak
- `shape`: Shape parameter
- `alpha`: Decay rate

```{r run-model, eval=FALSE}
# Note: This example uses reduced iterations for demonstration
# For actual analysis, use larger values (e.g., nmc=1000, niter=2000)

fitted_model <- run_mod(
  data = simulated_data,
  file_mod = serodynamics_example("model.jags"),
  nchain = 2,      # Number of MCMC chains
  nadapt = 100,    # Adaptation iterations
  nburn = 100,     # Burn-in iterations  
  nmc = 10,        # Samples per chain (use 1000+ for real analysis)
  niter = 20       # Total iterations (use 2000+ for real analysis)
)

head(fitted_model)
```

## Model Diagnostics

After fitting the model, check convergence diagnostics:

```{r diagnostics, eval=FALSE}
# Trace plots to assess chain mixing
plot_jags_trace(fitted_model)

# Density plots of posterior distributions
plot_jags_dens(fitted_model)

# Rhat statistics (values near 1.0 indicate convergence)
plot_jags_Rhat(fitted_model)

# Effective sample size
plot_jags_effect(fitted_model)
```

## Visualizing Fitted Curves

Plot the predicted antibody curves with credible intervals:

```{r plot-curves, eval=FALSE}
plot_predicted_curve(
  fitted_model,
  case_data = simulated_data,
  n_samples = 100  # Number of posterior samples to plot
)
```

## Post-Processing Results

Extract and summarize the posterior estimates:

```{r postprocess, eval=FALSE}
# Process JAGS output
processed_output <- postprocess_jags_output(fitted_model)

# Summarize parameter estimates
summary_stats <- post_summ(processed_output)
print(summary_stats)
```

## Working with Stratified Data

You can stratify the analysis by a grouping variable:

```{r stratified-example, eval=FALSE}
# Create stratified data
strat1 <- sim_case_data(
  n = 30, 
  curve_params = serocalculator::typhoid_curves_nostrat_100
) |>
  mutate(pathogen = "Typhoid")

strat2 <- sim_case_data(
  n = 30,
  curve_params = serocalculator::typhoid_curves_nostrat_100  
) |>
  mutate(pathogen = "Paratyphoid")

stratified_data <- bind_rows(strat1, strat2)

# Fit model with stratification
fitted_stratified <- run_mod(
  data = stratified_data,
  file_mod = serodynamics_example("model.jags"),
  nchain = 2,
  nadapt = 100,
  nburn = 100,
  nmc = 10,
  niter = 20,
  strat = "pathogen"  # Specify stratification variable
)
```

## Next Steps

- Explore the methodology vignette for details on the statistical model
- See the function reference for complete API documentation
- Check out example datasets: `?nepal_sees`, `?nepal_sees_jags_output`

## Session Info

```{r session-info}
sessionInfo()
```
